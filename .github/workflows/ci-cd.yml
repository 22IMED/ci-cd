name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:

  # ===== STAGE: VALIDATE =====
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Lint
        run: |
          pip install ruff
          ruff check .
          ruff format --check .

      - name: Security checks
        run: |
          python -m pip install --upgrade pip
          pip install bandit pip-audit
          bandit -r app
          pip-audit

      - name: Gitleaks scan
        uses: zricethezav/gitleaks-action@v8.21.2
        with:
          args: detect --no-banner --redact

  # ===== STAGE: TEST - Unit Tests =====
  unit_tests:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Unit Tests
        run: |
          export PYTHONPATH=$GITHUB_WORKSPACE
          pytest tests/unit

  # ===== STAGE: TEST - E2E Tests =====
  e2e_tests:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run E2E Tests
        run: |
          export PYTHONPATH=$GITHUB_WORKSPACE
          uvicorn app.main:app &
          sleep 5
          pytest tests/e2e

  # ===== STAGE: BUILD =====
  build:
    runs-on: ubuntu-latest
    needs: [unit_tests, e2e_tests]   # Build attend que tous les tests passent
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: |
          IMAGE_SHA=ghcr.io/${{ github.repository }}:${{ github.sha }}
          docker build -t $IMAGE_SHA .
          docker push $IMAGE_SHA
        env:
          DOCKER_BUILDKIT: 1

  # ===== STAGE: RELEASE =====
  release:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: "Gemini API release"

  # ===== STAGE: DEPLOY =====
  deploy:
    runs-on: ubuntu-latest
    needs: release
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Mock Deploy
        run: |
          echo "Deploying version ${{ github.ref_name }}"
          echo "Docker image: ghcr.io/${{ github.repository }}:${{ github.sha }}"
          echo "Deployment successful (mock)"
